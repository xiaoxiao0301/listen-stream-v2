# Prometheus Configuration for Listen Stream
# Scrapes metrics from all services and OTel Collector

global:
  scrape_interval:     15s    # Default scrape interval
  evaluation_interval: 15s   # Rule evaluation interval
  external_labels:
    cluster: "listen-stream"
    environment: "${ENVIRONMENT:-development}"

# ─── Alert Rules ──────────────────────────────────────────────────────────────
rule_files:
  - "/etc/prometheus/rules/*.yml"

# ─── AlertManager ─────────────────────────────────────────────────────────────
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - "alertmanager:9093"
      timeout: 10s

# ─── Scrape Configurations ────────────────────────────────────────────────────
scrape_configs:

  # ── Prometheus itself ──────────────────────────────────────────────────────
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  # ── OTel Collector metrics (exposes Listen Stream service metrics) ──────────
  - job_name: "otel-collector"
    static_configs:
      - targets: ["otel-collector:8889"]  # Prometheus exporter port
    metrics_path: "/metrics"

  # ── OTel Collector self-metrics ────────────────────────────────────────────
  - job_name: "otel-collector-internal"
    static_configs:
      - targets: ["otel-collector:8888"]

  # ── Go services (direct scrape via /metrics) ───────────────────────────────
  - job_name: "auth-svc"
    static_configs:
      - targets: ["auth-svc:8001"]
    metrics_path: "/metrics"
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
      - target_label: service
        replacement: "auth-svc"

  - job_name: "proxy-svc"
    static_configs:
      - targets: ["proxy-svc:8002"]
    metrics_path: "/metrics"
    scrape_interval: 10s  # Higher frequency — gateway is critical
    relabel_configs:
      - target_label: service
        replacement: "proxy-svc"

  - job_name: "user-svc"
    static_configs:
      - targets: ["user-svc:8003"]
    metrics_path: "/metrics"
    relabel_configs:
      - target_label: service
        replacement: "user-svc"

  - job_name: "sync-svc"
    static_configs:
      - targets: ["sync-svc:8004"]
    metrics_path: "/metrics"
    relabel_configs:
      - target_label: service
        replacement: "sync-svc"

  - job_name: "admin-svc"
    static_configs:
      - targets: ["admin-svc:8005"]
    metrics_path: "/metrics"
    relabel_configs:
      - target_label: service
        replacement: "admin-svc"

  # ── Consul metrics ────────────────────────────────────────────────────────
  - job_name: "consul"
    static_configs:
      - targets: ["consul-server-1:8500"]
    metrics_path: "/v1/agent/metrics"
    params:
      format: ["prometheus"]
    relabel_configs:
      - target_label: service
        replacement: "consul"

  # ── PostgreSQL metrics (via postgres_exporter) ────────────────────────────
  - job_name: "postgresql"
    static_configs:
      - targets: ["postgres-exporter:9187"]
    relabel_configs:
      - target_label: service
        replacement: "postgresql"

  # ── Redis metrics (via redis_exporter) ───────────────────────────────────
  - job_name: "redis"
    static_configs:
      - targets: ["redis-exporter:9121"]
    relabel_configs:
      - target_label: service
        replacement: "redis"

  # ── Jaeger metrics ────────────────────────────────────────────────────────
  - job_name: "jaeger"
    static_configs:
      - targets: ["jaeger:14269"]     # Jaeger admin port
    relabel_configs:
      - target_label: service
        replacement: "jaeger"

  # ── Elasticsearch metrics (via elasticsearch_exporter) ────────────────────
  - job_name: "elasticsearch"
    static_configs:
      - targets: ["elasticsearch-exporter:9114"]
    relabel_configs:
      - target_label: service
        replacement: "elasticsearch"

  # ── Node/host metrics (via node_exporter) ─────────────────────────────────
  - job_name: "node-exporter"
    static_configs:
      - targets: ["node-exporter:9100"]
    relabel_configs:
      - target_label: service
        replacement: "host"
