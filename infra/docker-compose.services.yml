# Listen Stream — Go Services Docker Compose
# Extends infra/docker-compose.yml with the actual application services
#
# Usage (start everything including services):
#   docker compose \
#     -f infra/docker-compose.yml \
#     -f infra/docker-compose.services.yml \
#     up -d

name: listen-stream

networks:
  backend:
    external: true
    name: listen-stream-backend
  monitoring:
    external: true
    name: listen-stream-monitoring

x-service-defaults: &service-defaults
  restart: unless-stopped
  networks: [backend, monitoring]
  env_file:
    - .env
  environment:
    CONSUL_HTTP_ADDR:            "consul-server-1:8500"
    OTEL_EXPORTER_OTLP_ENDPOINT: "otel-collector:4317"
    OTEL_SERVICE_VERSION:        "1.0.0"
    DEPLOYMENT_ENV:              "${ENVIRONMENT:-development}"

services:

  # ── auth-svc ───────────────────────────────────────────────────────────────
  auth-svc:
    <<: *service-defaults
    build:
      context: ../server/services/auth-svc
      dockerfile: Dockerfile
    container_name: listen-stream-auth-svc
    ports:
      - "8001:8001"   # HTTP
      - "9001:9001"   # gRPC
    environment:
      SERVICE_NAME:    "auth-svc"
      HTTP_PORT:       "8001"
      GRPC_PORT:       "9001"
      POSTGRES_DSN:    "postgres://${POSTGRES_USER:-listen_stream}:${POSTGRES_PASSWORD:-listen_stream_dev_password}@postgres:5432/${POSTGRES_DB:-listen_stream}?sslmode=disable"
      REDIS_ADDR:      "redis:6379"
    depends_on:
      - consul-server-1
      - postgres
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8001/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── proxy-svc ─────────────────────────────────────────────────────────────
  proxy-svc:
    <<: *service-defaults
    build:
      context: ../server/services/proxy-svc
      dockerfile: Dockerfile
    container_name: listen-stream-proxy-svc
    ports:
      - "8002:8002"   # HTTP
      - "9002:9002"   # gRPC
    environment:
      SERVICE_NAME:    "proxy-svc"
      HTTP_PORT:       "8002"
      GRPC_PORT:       "9002"
      REDIS_ADDR:      "redis:6379"
      AUTH_SVC_ADDR:   "auth-svc:9001"
    depends_on:
      - consul-server-1
      - redis
      - auth-svc
      - otel-collector
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8002/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── user-svc ──────────────────────────────────────────────────────────────
  user-svc:
    <<: *service-defaults
    build:
      context: ../server/services/user-svc
      dockerfile: Dockerfile
    container_name: listen-stream-user-svc
    ports:
      - "8003:8003"   # HTTP
      - "9003:9003"   # gRPC
    environment:
      SERVICE_NAME:  "user-svc"
      HTTP_PORT:     "8003"
      GRPC_PORT:     "9003"
      POSTGRES_DSN:  "postgres://${POSTGRES_USER:-listen_stream}:${POSTGRES_PASSWORD:-listen_stream_dev_password}@postgres:5432/${POSTGRES_DB:-listen_stream}?sslmode=disable"
      REDIS_ADDR:    "redis:6379"
    depends_on:
      - consul-server-1
      - postgres
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8003/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── sync-svc ──────────────────────────────────────────────────────────────
  sync-svc:
    <<: *service-defaults
    build:
      context: ../server/services/sync-svc
      dockerfile: Dockerfile
    container_name: listen-stream-sync-svc
    ports:
      - "8004:8004"   # HTTP + WebSocket
      - "9004:9004"   # gRPC
    environment:
      SERVICE_NAME: "sync-svc"
      HTTP_PORT:    "8004"
      GRPC_PORT:    "9004"
      REDIS_ADDR:   "redis:6379"
    depends_on:
      - consul-server-1
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8004/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── admin-svc ─────────────────────────────────────────────────────────────
  admin-svc:
    <<: *service-defaults
    build:
      context: ../server/services/admin-svc
      dockerfile: Dockerfile
    container_name: listen-stream-admin-svc
    ports:
      - "8005:8005"   # HTTP
    environment:
      SERVICE_NAME:  "admin-svc"
      HTTP_PORT:     "8005"
      POSTGRES_DSN:  "postgres://${POSTGRES_USER:-listen_stream}:${POSTGRES_PASSWORD:-listen_stream_dev_password}@postgres:5432/${POSTGRES_DB:-listen_stream}?sslmode=disable"
      REDIS_ADDR:    "redis:6379"
      CONSUL_ADDR:   "consul-server-1:8500"
    depends_on:
      - consul-server-1
      - postgres
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8005/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
