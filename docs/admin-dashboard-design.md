# Listen Stream 管理后台设计文档

> **版本**: 2.0  
> **日期**: 2026-03-01  
> **状态**: 详细设计阶段

---

## 📋 目录

1. [系统概述](#1-系统概述)
2. [功能架构](#2-功能架构)
3. [页面结构设计](#3-页面结构设计)
4. [页面详细设计与草图](#4-页面详细设计与草图)
5. [数据流设计](#5-数据流设计)
6. [安全与权限](#6-安全与权限)
7. [技术实现](#7-技术实现)

---

## 1. 系统概述

### 1.1 系统定位

Listen Stream 管理后台是一个面向系统管理员的 Web 应用，用于：
- 系统初始化与配置管理
- 用户与权限管理
- 运营数据统计与分析
- 系统监控与告警
- 操作审计与合规

### 1.2 用户角色

| 角色 | 权限范围 | 典型操作 |
|------|---------|---------|
| **SUPER_ADMIN** | 全部权限 | 系统配置、JWT轮换、创建管理员、敏感配置 |
| **ADMIN** | 日常管理 | 用户管理、内容审核、查看日志、数据统计 |
| **AUDITOR** (新增) | 只读审计 | 查看日志、导出报表、查看统计 |

### 1.3 技术栈

```yaml
前端:
  框架: React 19.0.0 + TypeScript 5.7.3
  构建: Vite 6.0.11
  UI组件: Radix UI (headless) + Tailwind CSS 4.0
  状态管理: Zustand 5.0.3
  数据获取: TanStack Query 5.65.1
  路由: React Router 7.1.3
  图表: Recharts 2.15.0
  表单: React Hook Form + Zod

后端:
  服务: admin-svc (Go + Gin)
  端口: :8005 (HTTP)
  认证: JWT + TOTP (可选)
  数据库: PostgreSQL 15
  缓存: Redis 7
```

---

## 2. 功能架构

### 2.1 核心功能模块

```
Listen Stream Admin Dashboard
│
├── 🔐 身份认证
│   ├── 首次初始化（创建超级管理员）
│   ├── 登录（用户名+密码+TOTP）
│   ├── 双因素认证设置
│   └── 密码修改
│
├── 📊 仪表盘（Dashboard）
│   ├── 实时指标（活跃用户、今日请求、错误率）
│   ├── 趋势图表（7天/30天）
│   ├── 系统健康状态
│   └── 最近告警
│
├── ⚙️ 系统配置（Config）
│   ├── API配置（QQ Music、Joox、NetEase、Kugou）
│   ├── JWT配置（密钥轮换、过期时间）
│   ├── SMS配置（多厂商Fallback）
│   ├── 功能开关（Token IP绑定、严格模式）
│   ├── 速率限制配置
│   └── 配置变更历史与回滚
│
├── 👥 用户管理（Users）
│   ├── 用户列表（搜索、筛选、分页）
│   ├── 用户详情（设备、收藏、播放历史）
│   ├── 批量操作（禁用、导出）
│   ├── 异常检测（多设备、高频请求）
│   └── 用户画像分析
│
├── 👨‍💼 管理员管理（Admins）
│   ├── 管理员列表
│   ├── 创建管理员（分配角色）
│   ├── 权限管理
│   ├── 2FA强制启用
│   └── 管理员操作日志
│
├── 📝 操作审计（Audit Logs）
│   ├── 日志查询（时间、操作类型、管理员）
│   ├── 敏感操作高亮
│   ├── 异常行为告警
│   ├── 导出报表（CSV/Excel）
│   └── 日志留存策略
│
├── 📈 数据统计（Analytics）
│   ├── 用户统计（活跃、留存、增长）
│   ├── 内容统计（热门歌曲、歌单、歌手）
│   ├── 性能统计（API响应时间、缓存命中率）
│   ├── 错误统计（错误类型、趋势）
│   └── 自定义报表
│
├── 🔔 监控告警（Monitoring）
│   ├── 实时告警列表
│   ├── 告警规则配置
│   ├── 告警通知渠道（Slack、Email、PagerDuty）
│   ├── 告警历史
│   └── 静默规则
│
├── 🎵 内容管理（Content）（新增）
│   ├── 热门内容推荐
│   ├── Banner管理
│   ├── 歌单审核（用户创建）
│   ├── 举报处理
│   └── 敏感内容过滤
│
└── 🛠️ 系统工具（Tools）
    ├── 缓存管理（清理指定key、批量失效）
    ├── 数据库维护（慢查询、索引优化）
    ├── 日志导出
    ├── 数据备份与恢复
    └── 系统诊断
```

### 2.2 功能优先级矩阵

| 功能模块 | P0 (必须) | P1 (重要) | P2 (可选) |
|---------|----------|----------|----------|
| 首次初始化 | ✅ ||
| 登录认证 | ✅ ||
| 仪表盘 | ✅ ||
| 系统配置 | ✅ ||
| 用户管理 | ✅ ||
| 操作审计 || ✅ ||
| 数据统计 || ✅ ||
| 管理员管理 || ✅ ||
| 监控告警 ||| ✅ |
| 内容管理 ||| ✅ |
| 系统工具 ||| ✅ |

---

## 3. 页面结构设计

### 3.1 整体布局

```
┌─────────────────────────────────────────────────────────────┐
│  Header (顶栏)                                               │
│  [Logo] Listen Stream Admin      [👤 Admin] [🔔 3] [⚙️]     │
└─────────────────────────────────────────────────────────────┘
┌──────────┬──────────────────────────────────────────────────┐
│          │                                                   │
│          │                                                   │
│ Sidebar  │           Main Content Area                      │
│ (侧边栏) │           (主内容区)                              │
│          │                                                   │
│  📊 仪表盘│                                                   │
│  ⚙️ 配置  │                                                   │
│  👥 用户  │                                                   │
│  👨‍💼 管理员│                                                   │
│  📝 审计  │                                                   │
│  📈 统计  │                                                   │
│  🔔 告警  │                                                   │
│  🎵 内容  │                                                   │
│  🛠️ 工具  │                                                   │
│          │                                                   │
│          │                                                   │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

### 3.2 路由结构

```typescript
const routes = [
  {
    path: '/setup',
    element: <SetupPage />,        // 首次初始化（未登录可访问）
  },
  {
    path: '/login',
    element: <LoginPage />,        // 登录页（未登录可访问）
  },
  {
    path: '/',
    element: <Layout />,           // 布局容器（需登录）
    children: [
      {
        path: '',
        element: <Navigate to="/dashboard" replace />,
      },
      {
        path: 'dashboard',
        element: <DashboardPage />,
      },
      {
        path: 'config',
        element: <ConfigPage />,
        meta: { roles: ['SUPER_ADMIN'] },
      },
      {
        path: 'config/history',
        element: <ConfigHistoryPage />,
        meta: { roles: ['SUPER_ADMIN', 'ADMIN'] },
      },
      {
        path: 'users',
        element: <UsersPage />,
      },
      {
        path: 'users/:id',
        element: <UserDetailPage />,
      },
      {
        path: 'admins',
        element: <AdminsPage />,
        meta: { roles: ['SUPER_ADMIN'] },
      },
      {
        path: 'audit',
        element: <AuditLogsPage />,
      },
      {
        path: 'analytics',
        element: <AnalyticsPage />,
      },
      {
        path: 'monitoring',
        element: <MonitoringPage />,
        meta: { roles: ['SUPER_ADMIN', 'ADMIN'] },
      },
      {
        path: 'content',
        element: <ContentPage />,
      },
      {
        path: 'tools',
        element: <ToolsPage />,
        meta: { roles: ['SUPER_ADMIN'] },
      },
      {
        path: 'profile',
        element: <ProfilePage />,     // 个人设置（2FA、密码）
      },
    ],
  },
];
```

---

## 4. 页面详细设计与草图

### 4.1 首次初始化页面 (SetupPage)

**使用场景**: 系统首次部署时，创建超级管理员

**页面布局**:

```
┌─────────────────────────────────────────────────────────────┐
│                                                              │
│                     🎵 Listen Stream                         │
│                     系统初始化                                │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │                                                     │     │
│  │  第1步: 生成JWT密钥  ✅                             │     │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │     │
│  │                                                     │     │
│  │  第2步: 数据库初始化  ✅                            │     │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │     │
│  │                                                     │     │
│  │  第3步: 创建超级管理员  ⏳                          │     │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │     │
│  │                                                     │     │
│  │  用户名  ┌────────────────────────────────────┐    │     │
│  │         │ admin                              │    │     │
│  │         └────────────────────────────────────┘    │     │
│  │                                                     │     │
│  │  密码    ┌────────────────────────────────────┐    │     │
│  │         │ ••••••••••••                       │    │     │
│  │         └────────────────────────────────────┘    │     │
│  │         ⚠️ 密码强度: 中等（建议至少12位，含大小写+数字+特殊字符）│
│  │                                                     │     │
│  │  确认密码┌────────────────────────────────────┐    │     │
│  │         │ ••••••••••••                       │    │     │
│  │         └────────────────────────────────────┘    │     │
│  │                                                     │     │
│  │  邮箱    ┌────────────────────────────────────┐    │     │
│  │         │ admin@listen-stream.com            │    │     │
│  │         └────────────────────────────────────┘    │     │
│  │                                                     │     │
│  │         ┌─────────────────────────────────────┐   │     │
│  │         │  完成初始化并登录  →                 │   │     │
│  │         └─────────────────────────────────────┘   │     │
│  │                                                     │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│              💡 提示: 请妥善保管管理员密码                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**交互流程**:
1. 自动执行步骤1-2（后端初始化JWT密钥、数据库迁移）
2. 用户填写表单
3. 密码强度实时检测（zxcvbn库）
4. 点击"完成初始化"→ POST /admin/setup
5. 成功后自动跳转登录页

---

### 4.2 登录页面 (LoginPage)

**页面布局**:

```
┌─────────────────────────────────────────────────────────────┐
│                                                              │
│                                                              │
│                     🎵 Listen Stream                         │
│                     管理后台登录                              │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │                                                     │     │
│  │  用户名  ┌────────────────────────────────────┐    │     │
│  │         │                                    │    │     │
│  │         └────────────────────────────────────┘    │     │
│  │                                                     │     │
│  │  密码    ┌────────────────────────────────────┐    │     │
│  │         │                                    │    │     │
│  │         └────────────────────────────────────┘    │     │
│  │                                                     │     │
│  │  [ ] 启用双因素认证                                │     │
│  │                                                     │     │
│  │  (如果勾选，显示下面的输入框)                       │     │
│  │  验证码  ┌────────────────────────────────────┐    │     │
│  │ (6位数) │                                    │    │     │
│  │         └────────────────────────────────────┘    │     │
│  │                                                     │     │
│  │         ┌─────────────────────────────────────┐   │     │
│  │         │         登录  →                      │   │     │
│  │         └─────────────────────────────────────┘   │     │
│  │                                                     │     │
│  │              [ 忘记密码? ]                          │     │
│  │                                                     │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│         🔒 系统使用https加密传输，保护您的账户安全             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**交互逻辑**:
1. 输入用户名+密码
2. 如果该管理员启用了TOTP，前端检测到后端返回`require_totp: true`，显示验证码输入框
3. 提交 → POST /admin/auth/login
4. 成功后存储JWT token (localStorage)，跳转到仪表盘

---

### 4.3 仪表盘页面 (DashboardPage)

**页面布局**:

```
┌─────────────────────────────────────────────────────────────┐
│  Header: Listen Stream Admin    [👤 admin] [🔔 3] [⚙️]      │
└─────────────────────────────────────────────────────────────┘
┌──────────┬──────────────────────────────────────────────────┐
│          │  📊 仪表盘                                        │
│ Sidebar  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│ 📊仪表盘  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌────────┐│
│ ⚙️配置   │  │ 👥      │ │ 💿      │ │ 📡      │ │ ⚠️     ││
│ 👥用户   │  │ 活跃用户 │ │ 今日播放│ │请求总数 │ │错误率  ││
│ 📝审计   │  │         │ │         │ │         │ │        ││
│ 📈统计   │  │ 12,458  │ │ 89,342  │ │1,245K  │ │ 0.23%  ││
│          │  │ +5.2%↑  │ │ +12.8%↑ │ │ +2.1%↑ │ │-0.05%↓ ││
│          │  └─────────┘ └─────────┘ └─────────┘ └────────┘│
│          │                                                   │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │  用户增长趋势 (近7天)                      │   │
│          │  │                                            │   │
│          │  │  6000┤                              ╭──   │   │
│          │  │      │                         ╭────╯      │   │
│          │  │  4000┤                    ╭────╯           │   │
│          │  │      │               ╭────╯                │   │
│          │  │  2000┤          ╭────╯                     │   │
│          │  │      │     ╭────╯                          │   │
│          │  │     0├─────┴────┴────┴────┴────┴────┴──── │   │
│          │  │      02/23 02/24 02/25 02/26 02/27 02/28  │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  ┌──────────────────┐ ┌───────────────────────┐  │
│          │  │ 系统健康状态      │ │ 最近告警              │  │
│          │  │ ━━━━━━━━━━━━━━━━ │ │ ━━━━━━━━━━━━━━━━━━━━│  │
│          │  │                  │ │                       │  │
│          │  │ ✅ auth-svc      │ │ ⚠️ 15:32 Redis连接数 │  │
│          │  │ ✅ proxy-svc     │ │    接近上限 (8500/10K)│  │
│          │  │ ✅ sync-svc      │ │                       │  │
│          │  │ ✅ PostgreSQL    │ │ ⚠️ 14:20 API错误率   │  │
│          │  │ ⚠️ Redis (高负载)│ │    超过阈值 (0.8%)    │  │
│          │  │ ✅ Consul        │ │                       │  │
│          │  │                  │ │ ℹ️ 12:05 配置变更:    │  │
│          │  │                  │ │    JWT过期时间更新    │  │
│          │  │                  │ │                       │  │
│          │  └──────────────────┘ └───────────────────────┘  │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

**数据刷新策略**:
- 实时指标卡片: 每30秒轮询
- 趋势图表: 每5分钟轮询
- 系统健康状态: 每1分钟轮询
- 最近告警: WebSocket实时推送

---

### 4.4 系统配置页面 (ConfigPage)

**页面布局**:

```
┌──────────┬──────────────────────────────────────────────────┐
│          │  ⚙️ 系统配置                  [💾 保存] [🔄重置]  │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ Sidebar  │                                                   │
│          │  选项卡: [API] [JWT] [SMS] [功能开关] [高级]     │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  ▼ API配置 - QQ Music (主源)                     │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ Base URL                                  │   │
│          │  │ ┌────────────────────────────────────────┐│   │
│          │  │ │ https://api.qq.com/music              ││   │
│          │  │ └────────────────────────────────────────┘│   │
│          │  │                                           │   │
│          │  │ API Key (加密存储)              [🔓显示]  │   │
│          │  │ ┌────────────────────────────────────────┐│   │
│          │  │ │ ••••••••••••••••••••••••              ││   │
│          │  │ └────────────────────────────────────────┘│   │
│          │  │                                           │   │
│          │  │ Cookie                                    │   │
│          │  │ ┌────────────────────────────────────────┐│   │
│          │  │ │ sessionid=abc123; uin=...             ││   │
│          │  │ └────────────────────────────────────────┘│   │
│          │  │                                           │   │
│          │  │ 速率限制: [20] req/s  [✅] 启用熔断       │   │
│          │  │                                           │   │
│          │  │ [测试连接]                   状态: ✅ 正常 │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  ▼ Fallback 源配置                                │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ 1️⃣ Joox      [✅] 启用   [配置] [测试]     │   │
│          │  │ 2️⃣ NetEase   [✅] 启用   [配置] [测试]     │   │
│          │  │ 3️⃣ Kugou     [  ] 启用   [配置] [测试]     │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  💡 提示: 配置保存后将立即生效，所有服务会自动重载 │
│          │                                                   │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │  配置历史  按钮: [查看变更历史]  [回滚到上一版本]  │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

**JWT配置选项卡**:

```
│  ▼ JWT配置                                                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 当前密钥版本: v3                                       │  │
│  │ 生成时间: 2026-02-15 10:30:25                          │  │
│  │                                                        │  │
│  │ Access Token 过期时间                                  │  │
│  │ ┌──────┐ 小时  ┌──────┐ 分钟  (默认: 1小时)           │  │
│  │ │  1   │       │  0   │                                │  │
│  │ └──────┘       └──────┘                                │  │
│  │                                                        │  │
│  │ Refresh Token 过期时间                                 │  │
│  │ ┌──────┐ 天    (默认: 7天)                             │  │
│  │ │  7   │                                                │  │
│  │ └──────┘                                                │  │
│  │                                                        │  │
│  │ [🔑 生成新密钥并轮换]  ⚠️ 将使所有旧Token失效          │  │
│  │                                                        │  │
│  │ [ ] Token IP绑定（启用后Token绑定客户端IP）            │  │
│  │                                                        │  │
│  └────────────────────────────────────────────────────────┘  │
```

**SMS配置选项卡**:

```
│  ▼ SMS配置 - Fallback链                                      │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 主供应商: [阿里云 ▼]                         [🟢 活跃] │  │
│  │                                                        │  │
│  │ Access Key ID                                          │  │
│  │ ┌──────────────────────────────────────────────────┐  │  │
│  │ │ LTAI5t...                                        │  │  │
│  │ └──────────────────────────────────────────────────┘  │  │
│  │                                                        │  │
│  │ Access Key Secret (加密存储)              [🔓显示]    │  │
│  │ ┌──────────────────────────────────────────────────┐  │  │
│  │ │ ••••••••••••••••••••••••                        │  │  │
│  │ └──────────────────────────────────────────────────┘  │  │
│  │                                                        │  │
│  │ 签名: [Listen Stream]  模板ID: [SMS_123456789]        │  │
│  │                                                        │  │
│  │ Fallback 1: [腾讯云 ▼]                    [  ] 启用   │  │
│  │ Fallback 2: [Twilio ▼]                   [  ] 启用   │  │
│  │                                                        │  │
│  │ [发送测试短信]  手机号: ┌──────────────┐              │  │
│  │                        │ +86 138****  │              │  │
│  │                        └──────────────┘              │  │
│  └────────────────────────────────────────────────────────┘  │
```

**功能开关选项卡**:

```
│  ▼ 功能开关                                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ [✅] Token IP绑定                                      │  │
│  │     启用后Token绑定客户端IP，防止Token泄露被盗用        │  │
│  │                                                        │  │
│  │ [✅] 设备数量限制                                      │  │
│  │     每用户最多 [5] 台设备                              │  │
│  │                                                        │  │
│  │ [  ] 严格登录模式                                      │  │
│  │     启用后每次登录需要短信验证码（关闭后仅新设备需要）  │  │
│  │                                                        │  │
│  │ [✅] 播放历史自动清理                                  │  │
│  │     每用户保留最新 [500] 条历史                        │  │
│  │                                                        │  │
│  │ [✅] 缓存预热                                          │  │
│  │     服务启动时预加载热门内容到缓存                      │  │
│  │                                                        │  │
│  │ [✅] WebSocket 心跳检测                                │  │
│  │     心跳间隔: [30] 秒                                  │  │
│  │                                                        │  │
│  │ [✅] 异常行为检测                                      │  │
│  │     自动检测并告警异常操作                             │  │
│  └────────────────────────────────────────────────────────┘  │
```

---

### 4.5 用户管理页面 (UsersPage)

**页面布局**:

```
┌──────────┬──────────────────────────────────────────────────┐
│          │  👥 用户管理                                      │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ Sidebar  │                                                   │
│          │  搜索: ┌─────────────────────┐  [🔍搜索]         │
│          │       │ 手机号/用户ID        │                   │
│          │       └─────────────────────┘                    │
│          │                                                   │
│          │  筛选: [全部状态 ▼] [全部角色 ▼] [注册时间 ▼]    │
│          │                                                   │
│          │  批量操作: [✓ 已选3项]  [禁用] [导出Excel]       │
│          │                                                   │
│          │  ┌────────────────────────────────────────────┐  │
│          │  │ □ 手机号      状态    角色   设备  注册时间  操作│
│          │  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│  │
│          │  │ □ 138****5678 ✅正常  USER   3/5  02-15   [详情]│
│          │  │ □ 139****1234 ✅正常  USER   2/5  02-20   [详情]│
│          │  │ ☑ 136****8888 🚫禁用  USER   1/5  01-10   [详情]│
│          │  │ □ 188****9999 ✅正常  USER   5/5  02-28   [详情]│
│          │  │ ☑ 150****6666 ⚠️异常  USER   8/5  02-25   [详情]│
│          │  │   (检测到异常: 设备数超限)                  │  │
│          │  │ ☑ 151****7777 ✅正常  ADMIN  2/5  01-01   [详情]│
│          │  │ □ 152****3333 ✅正常  USER   1/5  02-27   [详情]│
│          │  │                                            │  │
│          │  │ ... (更多用户)                             │  │
│          │  └────────────────────────────────────────────┘  │
│          │                                                   │
│          │  分页: [<] 1 2 3 ... 45 [>]   共 448 个用户      │
│          │                                                   │
│          │  统计摘要:                                        │
│          │  • 总用户: 12,458                                │
│          │  • 活跃用户(7天): 8,342                          │
│          │  • 禁用用户: 23                                  │
│          │  • 异常用户: 5 (需关注)                          │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

**用户详情弹窗** (点击[详情]按钮):

```
┌─────────────────────────────────────────────────────────────┐
│  用户详情 - 138****5678                           [✕]        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                              │
│  选项卡: [基本信息] [设备管理] [收藏] [播放历史] [操作]     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                              │
│  基本信息:                                                   │
│  • 用户ID: 550e8400-e29b-41d4-a716-446655440000            │
│  • 手机号: +86 138****5678                                  │
│  • 注册时间: 2026-02-15 14:32:18                            │
│  • 最后登录: 2026-03-01 10:23:45 (来自 iPhone 14 Pro)      │
│  • 状态: ✅ 正常                                             │
│  • 角色: USER                                               │
│  • Token版本: v3                                            │
│                                                              │
│  活跃度分析:                                                 │
│  • 登录次数 (7天): 23                                       │
│  • 播放次数 (7天): 156                                      │
│  • 收藏歌曲: 89                                             │
│  • 创建歌单: 5                                              │
│                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                              │
│  操作按钮:                                                   │
│  [撤销所有Token]  [禁用用户]  [删除用户]  [导出数据]        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**设备管理选项卡**:

```
│  设备列表:                                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 设备标识          平台       最后登录            操作   │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │ iPhone 14 Pro    iOS 17.3   2026-03-01 10:23   [撤销] │ │
│  │ MacBook Pro      macOS 14   2026-02-28 15:42   [撤销] │ │
│  │ Windows PC       Windows11  2026-02-25 20:11   [撤销] │ │
│  └────────────────────────────────────────────────────────┘ │
```

---

### 4.6 管理员管理页面 (AdminsPage)

**仅 SUPER_ADMIN 可访问**

```
┌──────────┬──────────────────────────────────────────────────┐
│          │  👨‍💼 管理员管理                  [+ 创建管理员]   │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  ┌────────────────────────────────────────────┐  │
│          │  │ 用户名     角色         2FA  最后登录    操作│  │
│          │  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│  │
│          │  │ admin     SUPER_ADMIN  ✅   03-01 10:00  [编辑]│
│          │  │ manager   ADMIN        ✅   03-01 09:30  [编辑]│
│          │  │ auditor   AUDITOR      ❌   02-28 16:20  [编辑]│
│          │  │ support   ADMIN        ✅   02-27 14:10  [编辑]│
│          │  └────────────────────────────────────────────┘  │
│          │                                                   │
│          │  权限矩阵:                                        │
│          │  ┌────────────────────────────────────────────┐  │
│          │  │ 功能模块      SUPER_ADMIN  ADMIN  AUDITOR │  │
│          │  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│  │
│          │  │ 配置管理         ✅         ❌      ❌     │  │
│          │  │ 用户管理         ✅         ✅      ❌     │  │
│          │  │ 管理员管理       ✅         ❌      ❌     │  │
│          │  │ 操作审计         ✅         ✅      ✅     │  │
│          │  │ 数据统计         ✅         ✅      ✅     │  │
│          │  │ 系统工具         ✅         ❌      ❌     │  │
│          │  │ 导出数据         ✅         ✅      ✅     │  │
│          │  └────────────────────────────────────────────┘  │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

**创建管理员弹窗**:

```
┌─────────────────────────────────────────────────────────────┐
│  创建管理员                                       [✕]        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                              │
│  用户名     ┌────────────────────────────────────────┐      │
│            │                                        │      │
│            └────────────────────────────────────────┘      │
│                                                              │
│  密码       ┌────────────────────────────────────────┐      │
│            │ ••••••••••••                           │      │
│            └────────────────────────────────────────┘      │
│            密码强度: 强 ✅                                   │
│                                                              │
│  邮箱       ┌────────────────────────────────────────┐      │
│            │                                        │      │
│            └────────────────────────────────────────┘      │
│                                                              │
│  角色       (•) ADMIN    ( ) AUDITOR                        │
│                                                              │
│  [✅] 强制启用双因素认证 (推荐)                              │
│                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                              │
│           [取消]                [创建]                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 4.7 操作审计页面 (AuditLogsPage)

```
┌──────────┬──────────────────────────────────────────────────┐
│          │  📝 操作审计日志                                  │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  筛选:                                            │
│          │  时间范围: [02-25] 至 [03-01]  [今天] [本周]     │
│          │  操作类型: [全部 ▼]                               │
│          │  管理员: [全部 ▼]                                 │
│          │  严重程度: [全部 ▼] [🔴高] [🟡中] [🟢低]          │
│          │                                                   │
│          │  [导出CSV] [导出Excel] [清除30天前日志]          │
│          │                                                   │
│          │  ┌────────────────────────────────────────────┐  │
│          │  │ 时间         管理员   操作        详情    IP   │
│          │  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│  │
│          │  │ 03-01 10:23  admin   🔴修改JWT密钥        ··· │
│          │  │                      (敏感操作)       [详情] │  │
│          │  │                                            │  │
│          │  │ 03-01 10:15  manager 🟡禁用用户138****   ··· │
│          │  │                                       [详情] │  │
│          │  │                                            │  │
│          │  │ 03-01 09:30  admin   🟢查看配置          ··· │
│          │  │                                       [详情] │  │
│          │  │                                            │  │
│          │  │ 02-28 18:42  support 🔴批量禁用5个用户   ··· │
│          │  │                      (异常操作)       [详情] │  │
│          │  │                                            │  │
│          │  │ 02-28 16:20  auditor 🟢导出用户数据      ··· │
│          │  │                                       [详情] │  │
│          │  └────────────────────────────────────────────┘  │
│          │                                                   │
│          │  分页: [<] 1 2 3 ... 120 [>]   共 1,198 条       │
│          │                                                   │
│          │  异常行为告警:                                    │
│          │  ⚠️ 检测到 support 在非工作时间 (18:42) 批量禁用用户│
│          │  ⚠️ admin 连续3次修改敏感配置 (10:20-10:25)       │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

**日志详情弹窗**:

```
┌─────────────────────────────────────────────────────────────┐
│  操作日志详情                                     [✕]        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                              │
│  请求ID: req_abc123xyz456                                   │
│  操作时间: 2026-03-01 10:23:45                              │
│  管理员: admin (SUPER_ADMIN)                                │
│  IP地址: 192.168.1.100                                      │
│  User-Agent: Mozilla/5.0 (Macintosh; ...)                  │
│                                                              │
│  操作类型: 修改JWT配置                                       │
│  严重程度: 🔴 高 (敏感操作)                                  │
│                                                              │
│  变更详情:                                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ {                                                      │ │
│  │   "action": "update_jwt_config",                       │ │
│  │   "changes": {                                         │ │
│  │     "access_token_expiry": {                           │ │
│  │       "old": "1h",                                     │ │
│  │       "new": "2h"                                      │ │
│  │     },                                                 │ │
│  │     "key_version": {                                   │ │
│  │       "old": "v2",                                     │ │
│  │       "new": "v3"                                      │ │
│  │     }                                                  │ │
│  │   },                                                   │ │
│  │   "reason": "密钥轮换"                                  │ │
│  │ }                                                      │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  影响范围: 所有现有Token将在24小时内失效                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 4.8 数据统计页面 (AnalyticsPage)

```
┌──────────┬──────────────────────────────────────────────────┐
│          │  📈 数据统计                                      │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  选项卡: [用户] [内容] [性能] [错误]              │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  时间范围: [近7天 ▼]  自定义: [02-23] 至 [03-01] │
│          │                                                   │
│          │  ▼ 用户统计                                       │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │  用户增长趋势                              │   │
│          │  │                                            │   │
│          │  │  15K┤                              ╭────  │   │
│          │  │     │                         ╭────╯       │   │
│          │  │  10K┤                    ╭────╯            │   │
│          │  │     │               ╭────╯                 │   │
│          │  │   5K┤          ╭────╯                      │   │
│          │  │     │     ╭────╯                           │   │
│          │  │    0├─────┴────┴────┴────┴────┴────┴───── │   │
│          │  │     02/23 02/24 02/25 02/26 02/27 02/28   │   │
│          │  │                                            │   │
│          │  │  ─ 总用户数  ─ 活跃用户  ─ 新增用户       │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  ┌──────────────┐  ┌──────────────┐             │
│          │  │ 用户留存率    │  │ 用户活跃度   │             │
│          │  │              │  │              │             │
│          │  │ 次日: 68%    │  │ DAU: 8,342   │             │
│          │  │ 7日: 42%     │  │ MAU: 32,156  │             │
│          │  │ 30日: 28%    │  │ DAU/MAU: 26% │             │
│          │  └──────────────┘  └──────────────┘             │
│          │                                                   │
│          │  ▼ 内容统计                                       │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ 热门歌曲 TOP 10                            │   │
│          │  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │   │
│          │  │ 1. 【歌曲名】- 歌手       播放: 12,456    │   │
│          │  │ 2. 【歌曲名】- 歌手       播放: 10,234    │   │
│          │  │ 3. 【歌曲名】- 歌手       播放: 9,876     │   │
│          │  │ ...                                        │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  ▼ 性能统计                                       │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ API响应时间 (P50 / P95 / P99)             │   │
│          │  │                                            │   │
│          │  │ /api/song/url       45ms / 120ms / 350ms  │   │
│          │  │ /api/playlist/*     30ms / 80ms / 200ms   │   │
│          │  │ /api/search/*       60ms / 150ms / 400ms  │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ 缓存命中率                                 │   │
│          │  │                                            │   │
│          │  │ L1内存缓存:  92.3% ████████████████░░      │   │
│          │  │ L2 Redis:    85.6% ███████████████░░░░    │   │
│          │  │ L3 Stale:    12.4% ██░░░░░░░░░░░░░░░░     │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

---

### 4.9 监控告警页面 (MonitoringPage)

```
┌──────────┬──────────────────────────────────────────────────┐
│          │  🔔 监控告警                      [配置告警规则]  │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  筛选: [全部 ▼] [🔴严重] [🟡警告] [🟢信息]        │
│          │       [未确认] [已确认] [已解决]                  │
│          │                                                   │
│          │  ┌────────────────────────────────────────────┐  │
│          │  │ 时间      级别  告警内容           状态  操作│  │
│          │  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│  │
│          │  │ 15:32    🔴   Redis连接数接近上限   未确认   │  │
│          │  │               (8500/10000)        [确认][详情]│
│          │  │                                            │  │
│          │  │ 14:20    🟡   auth-svc错误率超标   已确认   │  │
│          │  │               (0.8% > 0.5%)       [详情]   │  │
│          │  │                                            │  │
│          │  │ 12:05    🟢   配置变更: JWT过期时间  已解决   │  │
│          │  │                                   [详情]   │  │
│          │  │                                            │  │
│          │  │ 11:30    🔴   PostgreSQL磁盘使用率  未确认   │  │
│          │  │               (85% > 80%)         [确认][详情]│
│          │  │                                            │  │
│          │  │ 10:15    🟡   WebSocket连接数升高   已解决   │  │
│          │  │               (7200 > 7000)       [详情]   │  │
│          │  └────────────────────────────────────────────┘  │
│          │                                                   │
│          │  分页: [<] 1 2 3 [>]                             │
│          │                                                   │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  告警统计 (近7天):                                │
│          │  ┌─────────────────────────────────────┐         │
│          │  │ 🔴 严重: 3   🟡 警告: 12   🟢 信息: 45│         │
│          │  └─────────────────────────────────────┘         │
│          │                                                   │
│          │  ▼ 服务健康状态                                   │
│          │  ┌────────────────────────────────────────────┐  │
│          │  │ auth-svc       ✅ 正常  CPU: 25%  Mem: 45% │  │
│          │  │ proxy-svc      ✅ 正常  CPU: 35%  Mem: 52% │  │
│          │  │ sync-svc       ✅ 正常  CPU: 18%  Mem: 38% │  │
│          │  │ admin-svc      ✅ 正常  CPU: 12%  Mem: 28% │  │
│          │  │ PostgreSQL     ⚠️ 磁盘高 CPU: 42%  Mem: 68%│  │
│          │  │ Redis          ⚠️ 连接高 CPU: 55%  Mem: 72%│  │
│          │  │ Consul         ✅ 正常  CPU: 8%   Mem: 15% │  │
│          │  └────────────────────────────────────────────┘  │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

**告警规则配置弹窗**:

```
┌─────────────────────────────────────────────────────────────┐
│  告警规则配置                                     [✕]        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                              │
│  ▼ 错误率告警                                                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ [✅] 启用                                              │ │
│  │                                                        │ │
│  │ 服务: [全部 ▼]                                         │ │
│  │                                                        │ │
│  │ 阈值: 错误率超过 [0.5] %                               │ │
│  │       持续时间 [5] 分钟                                │ │
│  │                                                        │ │
│  │ 严重程度: (•) 警告  ( ) 严重                           │ │
│  │                                                        │ │
│  │ 通知渠道: [✅] Slack  [✅] Email  [  ] PagerDuty       │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ▼ 资源使用告警                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ [✅] 启用                                              │ │
│  │                                                        │ │
│  │ 指标:                                                  │ │
│  │  [✅] CPU使用率 > [80] %                              │ │
│  │  [✅] 内存使用率 > [85] %                             │ │
│  │  [✅] 磁盘使用率 > [80] %                             │ │
│  │                                                        │ │
│  │ 持续时间: [10] 分钟                                    │ │
│  │                                                        │ │
│  │ 通知渠道: [✅] Slack  [  ] Email  [✅] PagerDuty       │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                              │
│           [取消]                [保存]                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 4.10 个人设置页面 (ProfilePage)

```
┌──────────┬──────────────────────────────────────────────────┐
│          │  👤 个人设置                                      │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  选项卡: [基本信息] [安全设置] [偏好设置]         │
│          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│          │                                                   │
│          │  ▼ 基本信息                                       │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ 用户名: admin                              │   │
│          │  │ 角色: SUPER_ADMIN                          │   │
│          │  │ 邮箱: admin@listen-stream.com              │   │
│          │  │                                            │   │
│          │  │ 邮箱  ┌────────────────────────────────┐   │   │
│          │  │      │ admin@listen-stream.com        │   │   │
│          │  │      └────────────────────────────────┘   │   │
│          │  │                                        [修改]│  │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  ▼ 安全设置                                       │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ 修改密码                                   │   │
│          │  │                                            │   │
│          │  │ 当前密码 ┌─────────────────────────────┐  │   │
│          │  │         │ ••••••••••••                │  │   │
│          │  │         └─────────────────────────────┘  │   │
│          │  │                                            │   │
│          │  │ 新密码   ┌─────────────────────────────┐  │   │
│          │  │         │ ••••••••••••                │  │   │
│          │  │         └─────────────────────────────┘  │   │
│          │  │         密码强度: 强 ✅                    │   │
│          │  │                                            │   │
│          │  │ 确认密码 ┌─────────────────────────────┐  │   │
│          │  │         │ ••••••••••••                │  │   │
│          │  │         └─────────────────────────────┘  │   │
│          │  │                                            │   │
│          │  │                                   [修改密码]│  │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ 双因素认证 (TOTP)                          │   │
│          │  │                                            │   │
│          │  │ 状态: ✅ 已启用                             │   │
│          │  │                                            │   │
│          │  │ 设备: Google Authenticator                 │   │
│          │  │ 绑定时间: 2026-02-15 10:30                 │   │
│          │  │                                            │   │
│          │  │                        [禁用] [重新绑定]   │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
│          │  ▼ 偏好设置                                       │
│          │  ┌───────────────────────────────────────────┐   │
│          │  │ 语言: [简体中文 ▼]                         │   │
│          │  │ 时区: [Asia/Shanghai (UTC+8) ▼]           │   │
│          │  │ 主题: (•) 浅色  ( ) 深色  ( ) 自动         │   │
│          │  │                                            │   │
│          │  │ 通知设置:                                  │   │
│          │  │  [✅] 系统告警通知                         │   │
│          │  │  [✅] 邮件摘要 (每日)                      │   │
│          │  │  [  ] 短信通知 (仅严重告警)               │   │
│          │  └───────────────────────────────────────────┘   │
│          │                                                   │
└──────────┴──────────────────────────────────────────────────┘
```

---

## 5. 数据流设计

### 5.1 配置更新流程

```
┌─────────────────────────────────────────────────────────────┐
│  配置更新流程 (热更新)                                       │
└─────────────────────────────────────────────────────────────┘

1. 管理员编辑配置
   Admin Web → PUT /admin/config/api
   
2. admin-svc 处理:
   • 验证配置合法性
   • 生成新版本号 (v4)
   • 加密存储敏感字段
   • 写入 PostgreSQL (system_configs + config_history)
   
3. 通知其他服务:
   • Redis Pub/Sub: PUBLISH config:update {"key": "API_BASE_URL", "version": "v4"}
   • Consul Event: 触发配置变更事件
   
4. 各服务响应:
   • 接收到 Pub/Sub 消息
   • 清除本地缓存 (ConfigService cache)
   • 从 Consul KV / PostgreSQL 重新加载配置
   • 日志记录: "Config reloaded: API_BASE_URL v4"
   
5. 前端轮询:
   • 每30秒 GET /admin/config/version
   • 检测到版本变化 → 刷新配置页面
```

### 5.2 用户禁用流程

```
┌─────────────────────────────────────────────────────────────┐
│  用户禁用流程                                                │
└─────────────────────────────────────────────────────────────┘

1. 管理员操作:
   UsersPage → 点击 [禁用] → 确认弹窗 → POST /admin/users/{id}/disable
   
2. admin-svc 处理:
   • 验证权限 (SUPER_ADMIN / ADMIN)
   • 更新 users 表: disabled = true
   • 撤销所有 RT: DELETE FROM devices WHERE user_id = {id}
   • Redis: DEL rt:{device_id}
   • 记录审计日志: operation_logs (action: "disable_user", reason: "...")
   
3. 通知 auth-svc:
   • Redis Pub/Sub: PUBLISH user:disabled {user_id}
   • auth-svc 接收到 → 清除该用户的 JWT 白名单缓存
   
4. 客户端响应:
   • 用户下次请求 → JWT验证失败 (401)
   • 客户端接收401 → 清除本地Token → 跳转到登录页
   • 显示: "您的账号已被禁用，请联系管理员"
```

### 5.3 实时监控数据流

```
┌─────────────────────────────────────────────────────────────┐
│  实时监控数据流                                              │
└─────────────────────────────────────────────────────────────┘

1. 指标收集 (各服务):
   • Prometheus client_golang 导出 /metrics
   • 指标类型: Counter (请求数、错误数)、Histogram (响应时间)、Gauge (活跃连接)
   
2. Prometheus 抓取:
   • 每15秒抓取一次各服务的 /metrics
   • 存储到 TSDB (时序数据库)
   
3. AlertManager 规则评估:
   • 每1分钟评估告警规则
   • 触发条件: error_rate > 0.005 for 5m
   • 发送告警 → Slack / Email / PagerDuty
   
4. admin-svc 数据聚合:
   • 每分钟查询 Prometheus: PromQL
   • 缓存到 Redis: daily:stats:active_users (INCR)
   • WebSocket 推送到 MonitoringPage
   
5. 前端展示:
   • Recharts 渲染实时图表
   • 告警列表自动更新 (WebSocket / 轮询)
```

---

## 6. 安全与权限

### 6.1 认证流程

```yaml
登录认证:
  1. 用户输入 用户名 + 密码
  2. 后端验证 Argon2id 哈希
  3. 如果启用 2FA:
     - 验证 TOTP 验证码 (pquerna/otp)
     - 时间窗口: 30秒, 允许±1个窗口
  4. 签发 JWT Access Token (1小时)
  5. 前端存储到 localStorage
  6. 后续请求携带: Authorization: Bearer {token}

Token刷新:
  - Access Token 过期前5分钟自动刷新
  - 使用 Axios 拦截器自动处理

会话管理:
  - 30分钟无操作 → 自动退出
  - 多设备登录: 允许,每个设备独立Token
```

### 6.2 权限控制矩阵

| 功能模块 | SUPER_ADMIN | ADMIN | AUDITOR |
|---------|------------|-------|---------|
| **配置管理** ||||
| 查看配置 | ✅ | ✅ | ❌ |
| 修改配置 | ✅ | ❌ | ❌ |
| JWT轮换 | ✅ | ❌ | ❌ |
| 配置历史 | ✅ | ✅ | ✅ |
| **用户管理** ||||
| 查看用户 | ✅ | ✅ | ✅ |
| 禁用用户 | ✅ | ✅ | ❌ |
| 删除用户 | ✅ | ❌ | ❌ |
| 导出数据 | ✅ | ✅ | ✅ |
| **管理员管理** ||||
| 查看管理员 | ✅ | ❌ | ❌ |
| 创建管理员 | ✅ | ❌ | ❌ |
| 修改角色 | ✅ | ❌ | ❌ |
| **操作审计** ||||
| 查看日志 | ✅ | ✅ | ✅ |
| 导出报表 | ✅ | ✅ | ✅ |
| 清除日志 | ✅ | ❌ | ❌ |
| **数据统计** ||||
| 查看统计 | ✅ | ✅ | ✅ |
| 导出报表 | ✅ | ✅ | ✅ |
| **监控告警** ||||
| 查看告警 | ✅ | ✅ | ✅ |
| 配置规则 | ✅ | ✅ | ❌ |
| 确认告警 | ✅ | ✅ | ❌ |
| **系统工具** ||||
| 缓存管理 | ✅ | ❌ | ❌ |
| 数据库维护 | ✅ | ❌ | ❌ |
| 系统诊断 | ✅ | ❌ | ❌ |

### 6.3 安全最佳实践

```yaml
密码策略:
  - 最小长度: 12位
  - 复杂度: 必须包含大小写+数字+特殊字符
  - 历史密码: 不允许重复最近3次
  - 强制更换: 90天 (SUPER_ADMIN可配置)

2FA (TOTP):
  - SUPER_ADMIN 强制启用
  - ADMIN / AUDITOR 可选启用
  - 备用码: 生成10个一次性恢复码

审计日志:
  - 所有敏感操作记录
  - 保留期: 180天
  - 不可篡改: 使用 PostgreSQL WAL归档
  - 敏感字段自动脱敏

IP白名单 (可选):
  - 限制管理后台访问IP
  - 配置: system_configs.admin_allowed_ips
  - 格式: ["192.168.1.0/24", "10.0.0.100"]

会话安全:
  - CSP: Content-Security-Policy header
  - CSRF: SameSite Cookie + Token
  - XSS: 自动转义所有输出
  - 点击劫持: X-Frame-Options: DENY
```

---

## 7. 技术实现

### 7.1 前端状态管理

```typescript
// stores/auth.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface AuthState {
  token: string | null;
  user: AdminUser | null;
  isAuthenticated: boolean;
  login: (username: string, password: string, totp?: string) => Promise<void>;
  logout: () => void;
  refreshToken: () => Promise<void>;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      token: null,
      user: null,
      isAuthenticated: false,
      
      login: async (username, password, totp) => {
        const res = await api.auth.login({ username, password, totp });
        set({ 
          token: res.access_token, 
          user: res.user, 
          isAuthenticated: true 
        });
      },
      
      logout: () => {
        set({ token: null, user: null, isAuthenticated: false });
      },
      
      refreshToken: async () => {
        const res = await api.auth.refresh();
        set({ token: res.access_token });
      },
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({ token: state.token }),
    }
  )
);
```

### 7.2 API客户端

```typescript
// api/client.ts
import axios from 'axios';
import { useAuthStore } from '@/stores/auth';

const client = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 30000,
});

// 请求拦截器: 注入Token
client.interceptors.request.use((config) => {
  const token = useAuthStore.getState().token;
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 响应拦截器: 处理401自动刷新
client.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;
    
    // 401 + 非登录接口 + 未重试过 → 尝试刷新Token
    if (
      error.response?.status === 401 &&
      !originalRequest.url.includes('/auth/login') &&
      !originalRequest._retry
    ) {
      originalRequest._retry = true;
      
      try {
        await useAuthStore.getState().refreshToken();
        return client(originalRequest);
      } catch (refreshError) {
        useAuthStore.getState().logout();
        window.location.href = '/login';
        return Promise.reject(refreshError);
      }
    }
    
    return Promise.reject(error);
  }
);

export default client;
```

### 7.3 权限路由守卫

```typescript
// components/ProtectedRoute.tsx
import { Navigate } from 'react-router-dom';
import { useAuthStore } from '@/stores/auth';

interface ProtectedRouteProps {
  children: React.ReactNode;
  roles?: string[];
}

export function ProtectedRoute({ children, roles }: ProtectedRouteProps) {
  const { isAuthenticated, user } = useAuthStore();
  
  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }
  
  if (roles && !roles.includes(user?.role || '')) {
    return <Navigate to="/unauthorized" replace />;
  }
  
  return <>{children}</>;
}
```

### 7.4 实时数据更新 (React Query)

```typescript
// hooks/useRealtimeStats.ts
import { useQuery } from '@tanstack/react-query';
import { api } from '@/api';

export function useRealtimeStats() {
  return useQuery({
    queryKey: ['stats', 'realtime'],
    queryFn: () => api.stats.getRealtime(),
    refetchInterval: 30000, // 每30秒刷新
    staleTime: 20000,       // 20秒内数据视为新鲜
  });
}

// 使用示例
function DashboardPage() {
  const { data, isLoading } = useRealtimeStats();
  
  if (isLoading) return <Spinner />;
  
  return (
    <div>
      <StatCard label="活跃用户" value={data.active_users} />
      <StatCard label="今日播放" value={data.today_plays} />
    </div>
  );
}
```

### 7.5 表单验证 (Zod)

```typescript
// schemas/configSchema.ts
import { z } from 'zod';

export const apiConfigSchema = z.object({
  base_url: z.string().url('请输入有效的URL'),
  api_key: z.string().min(1, 'API Key不能为空'),
  cookie: z.string().optional(),
  rate_limit: z.number().min(1).max(100),
  enable_circuit_breaker: z.boolean(),
});

export type APIConfigInput = z.infer<typeof apiConfigSchema>;

// 使用示例
function ConfigForm() {
  const { register, handleSubmit, formState: { errors } } = useForm<APIConfigInput>({
    resolver: zodResolver(apiConfigSchema),
  });
  
  const onSubmit = async (data: APIConfigInput) => {
    await api.config.updateAPI(data);
    toast.success('配置已更新');
  };
  
  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <input {...register('base_url')} />
      {errors.base_url && <span>{errors.base_url.message}</span>}
      
      <button type="submit">保存</button>
    </form>
  );
}
```

---

## 8. 开发计划

### 8.1 开发阶段

| 阶段 | 功能 | 工期 | 优先级 |
|------|------|------|--------|
| **Alpha** | 首次初始化、登录、仪表盘、基本配置 | 2周 | P0 |
| **Beta** | 用户管理、操作审计、数据统计 | 2周 | P0 |
| **RC** | 管理员管理、监控告警、系统工具 | 2周 | P1 |
| **Release** | 内容管理、高级功能、优化 | 1周 | P2 |

### 8.2 测试策略

```yaml
单元测试:
  覆盖率目标: >70%
  工具: Vitest + React Testing Library
  重点: 
    - 状态管理逻辑
    - API客户端
    - 表单验证

E2E测试:
  工具: Playwright
  场景:
    - 完整登录流程 (含2FA)
    - 配置更新并验证生效
    - 用户禁用并验证客户端响应

性能测试:
  工具: Lighthouse CI
  指标:
    - FCP < 1.5s
    - LCP < 2.5s
    - TBT < 300ms

安全测试:
  工具: OWASP ZAP
  检查:
    - XSS注入
    - CSRF防护
    - 敏感信息泄露
```

---

## 9. 部署与运维

### 9.1 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│  Nginx (反向代理 + SSL 终结)                                 │
│  https://admin.listen-stream.com                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│  Docker Container: admin-web                                 │
│  - Nginx 静态文件服务器                                       │
│  - React 构建产物 (/usr/share/nginx/html)                    │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ API请求
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  Docker Container: admin-svc :8005                           │
│  - Go二进制                                                  │
│  - 连接 PostgreSQL + Redis                                   │
└─────────────────────────────────────────────────────────────┘
```

### 9.2 环境变量

```bash
# .env.production
VITE_API_BASE_URL=https://api.listen-stream.com
VITE_WS_BASE_URL=wss://api.listen-stream.com
VITE_ENABLE_DEBUG=false
```

### 9.3 监控与日志

```yaml
日志收集:
  ELK Stack: 
    - Filebeat → Logstash → Elasticsearch → Kibana
  格式: JSON structured logging
  字段: timestamp, level, request_id, user_id, action, details

指标监控:
  Prometheus: 
    - admin-web 访问量
    - admin-svc API响应时间
    - 操作审计事件计数
  Grafana Dashboard:
    - 管理员活跃度
    - 配置变更频率
    - 告警触发统计

告警:
  AlertManager:
    - 管理后台5xx错误 > 10次/5min
    - 敏感操作 (JWT轮换、批量禁用用户)
    - 异常登录 (非工作时间、异地IP)
```

---

## 10. 总结

本设计文档详细描述了 Listen Stream 管理后台的完整设计，包括：

✅ **10个核心页面**，每个都有详细的布局草图  
✅ **3种用户角色**，权限矩阵清晰明确  
✅ **5条数据流**，覆盖配置更新、用户管理、实时监控  
✅ **完整的技术栈**，从前端到后端到部署  
✅ **安全最佳实践**，包括2FA、审计、IP白名单  

### 后续步骤

1. **评审设计** → 与团队确认需求完整性
2. **创建UI设计稿** → 使用 Figma 完善视觉设计
3. **搭建前端项目** → Vite + React + TypeScript + Radix UI
4. **实现 admin-svc API** → Go + Gin + PostgreSQL
5. **集成测试** → E2E + 性能 + 安全
6. **部署上线** → Docker + Nginx + SSL

---

**文档维护**:  
- 版本: 2.0  
- 最后更新: 2026-03-01  
- 维护者: Dev Team  
