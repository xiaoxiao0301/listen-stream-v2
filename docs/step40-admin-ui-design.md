# 步骤40: React管理后台适配 - 详细设计

> **目标**: 为新架构提供强大的管理后台，支持配置版本控制、异常告警、数据可视化  
> **技术栈**: React 19 + TypeScript + Radix UI + Recharts + TanStack Query  
> **完成时间**: 阶段8（第12周）

---

## 📋 功能点总览

### 1. 新API对接（技术实现）

#### 1.1 API Client重构
**文件**: `admin/src/api/client.ts`

**功能点**:
- ✅ **gRPC-Web支持**: 通过Envoy代理调用后端gRPC服务
- ✅ **JWT自动刷新**: Axios拦截器处理401，自动刷新Token
- ✅ **请求重试**: 网络错误自动重试（最多3次）
- ✅ **错误归一化**: 统一处理HTTP/gRPC错误
- ✅ **请求ID追踪**: 每个请求注入 X-Request-ID

```typescript
// 示例：新API Client配置
import axios from 'axios';
import { setupInterceptors } from './interceptors';

const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 注入拦截器
setupInterceptors(apiClient);

export default apiClient;
```

#### 1.2 新增API端点
**文件**: `admin/src/api/`

| 文件 | 端点 | 说明 |
|------|------|------|
| `config.ts` | `GET /admin/config/history` | 配置变更历史 |
| | `POST /admin/config/rollback` | 回滚到指定版本 |
| `logs.ts` | `GET /admin/logs/anomalies` | 异常活动列表 |
| | `POST /admin/logs/export` | 导出审计日志 |
| `stats.ts` | `GET /admin/stats/realtime` | 实时指标 |
| | `GET /admin/stats/daily` | 每日统计 |
| `alerts.ts` | `GET /admin/alerts` | 告警列表 |
| | `POST /admin/alerts/{id}/ack` | 确认告警 |

---

### 2. 配置管理界面（版本控制）

#### 2.1 功能点清单

##### 2.1.1 配置分类管理
**功能**:
- ✅ **JWT配置**: 密钥、密钥版本、过期时间、IP绑定开关
- ✅ **API配置**: QQ Music、Joox、NetEase、Kugou的API地址、密钥、Cookie
- ✅ **SMS配置**: 阿里云、腾讯云、Twilio的AccessKey、SecretKey、签名
- ✅ **功能开关**: Token IP绑定、TOTP强制启用、严格设备限制

##### 2.1.2 配置编辑
**功能**:
- ✅ **实时验证**: 输入时验证格式（URL、密钥长度）
- ✅ **敏感字段**: 密钥/密码显示为 `***`，点击眼睛图标显示明文
- ✅ **测试连接**: 保存前测试API/SMS是否可用
- ✅ **变更预览**: 显示修改前后的差异（Diff视图）
- ✅ **变更原因**: 必填字段，记录变更说明

##### 2.1.3 版本控制
**功能**:
- ✅ **版本列表**: 显示所有历史版本（时间、操作人、变更说明）
- ✅ **版本对比**: 选择两个版本，Diff显示差异
- ✅ **一键回滚**: 恢复到任意历史版本
- ✅ **回滚确认**: 二次确认弹窗，防止误操作
- ✅ **自动备份**: 每次变更自动创建历史版本

##### 2.1.4 变更通知
**功能**:
- ✅ **实时生效**: 保存后通过Redis Pub/Sub通知所有服务
- ✅ **生效状态**: 显示各服务的缓存清除状态
- ✅ **超时告警**: 如果服务60秒未响应，显示警告

---

#### 2.2 页面草图

```
┌──────────────────────────────────────────────────────────────────────────┐
│ Listen Stream Admin - 配置管理                          [admin@system] ▼ │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ 📍 导航: 首页 > 系统设置 > 配置管理                                 ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ Tab:  [ JWT配置 ]  [ API配置 ]  [ SMS配置 ]  [ 功能开关 ]         ││
│  │       ─────────                                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐
│  │ JWT配置                                        当前版本: v12 ⚡实时生效│
│  ├──────────────────────────────────────────────────────────────────────┤
│  │                                                                       │
│  │  JWT签名密钥 *                                                        │
│  │  [ ******************************** ] [👁 显示] [🔄 重新生成]        │
│  │  ⚠️  重新生成将导致所有现有Token失效                                  │
│  │                                                                       │
│  │  密钥版本 *                                                           │
│  │  [ v12 ] (只读)  最后更新: 2026-02-25 14:30:00                       │
│  │                                                                       │
│  │  Access Token过期时间 *                                              │
│  │  [ 15 ] 分钟     [Slider: 5 ←─●────→ 120]                           │
│  │                                                                       │
│  │  Refresh Token过期时间 *                                             │
│  │  [ 7 ] 天        [Slider: 1 ←─────●─→ 30]                           │
│  │                                                                       │
│  │  ┌────────────────────────────────────────────────────────────────┐ │
│  │  │ 高级选项 ▼                                                      │ │
│  │  ├────────────────────────────────────────────────────────────────┤ │
│  │  │  ☑ 启用Token IP绑定 (严格模式)                                  │ │
│  │  │     Token绑定客户端IP，切换网络需重新登录                       │ │
│  │  │                                                                  │ │
│  │  │  ☑ 启用设备指纹检测                                             │ │
│  │  │     检测设备特征突变，自动触发安全验证                          │ │
│  │  └────────────────────────────────────────────────────────────────┘ │
│  │                                                                       │
│  │  变更说明 *                                                           │
│  │  ┌────────────────────────────────────────────────────────────────┐ │
│  │  │ 为提升安全性，缩短Access Token过期时间至15分钟                  │ │
│  │  │                                                                  │ │
│  │  └────────────────────────────────────────────────────────────────┘ │
│  │                                                                       │
│  │  [ 📜 查看历史版本(23) ]     [ 测试配置 ]  [ 💾 保存并生效 ]       │
│  │                                                                       │
│  └──────────────────────────────────────────────────────────────────────┘
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐
│  │ 📊 生效状态                                                           │
│  ├──────────────────────────────────────────────────────────────────────┤
│  │  auth-svc-01    [✅ 已生效]  2秒前                                   │
│  │  auth-svc-02    [✅ 已生效]  2秒前                                   │
│  │  proxy-svc-01   [✅ 已生效]  3秒前                                   │
│  │  user-svc-01    [⚠️ 等待中]  正在清除缓存...                         │
│  └──────────────────────────────────────────────────────────────────────┘
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

#### 2.3 版本历史弹窗

```
┌────────────────────────────────────────────────────────────────────────┐
│ JWT配置 - 版本历史                                        [✕ 关闭]     │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  搜索: [___________________] 🔍   时间: [最近7天 ▼]                    │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ ✓ 版本  时间                操作人      变更说明            操作  │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │ ⭐ v12  2026-02-25 14:30  admin      缩短Token过期时间  [回滚] │ │
│  │   v11  2026-02-20 09:15  admin      启用IP绑定          [回滚] │ │
│  │   v10  2026-02-15 16:45  superadmin 轮换JWT密钥         [回滚] │ │
│  │   v9   2026-02-10 11:20  admin      增加设备指纹检测    [回滚] │ │
│  │   v8   2026-02-05 14:00  admin      调整RT过期时间      [回滚] │ │
│  │   ... (更多)                                                     │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  [ 对比选中版本 ]  [ 导出历史 ]                         [ 关闭 ]      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

#### 2.4 版本对比视图

```
┌────────────────────────────────────────────────────────────────────────┐
│ 版本对比: v10 (2026-02-15) ↔ v12 (2026-02-25)            [✕ 关闭]     │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────┬────────────────────────────────────┐  │
│  │      v10 (旧版本)          │      v12 (当前版本)                │  │
│  ├────────────────────────────┼────────────────────────────────────┤  │
│  │  JWT签名密钥              │  JWT签名密钥                       │  │
│  │  abc123***                │  xyz789***                         │  │
│  │  ────────────────────────  │  ────────────────────────────────  │  │
│  │  Access Token过期时间      │  Access Token过期时间              │  │
│  │  🔴 30 分钟                │  🟢 15 分钟                        │  │
│  │  ────────────────────────  │  ────────────────────────────────  │  │
│  │  Refresh Token过期时间     │  Refresh Token过期时间             │  │
│  │  7 天                      │  7 天                              │  │
│  │  ────────────────────────  │  ────────────────────────────────  │  │
│  │  Token IP绑定              │  Token IP绑定                      │  │
│  │  🔴 禁用                   │  🟢 启用                           │  │
│  │  ────────────────────────  │  ────────────────────────────────  │  │
│  │  设备指纹检测              │  设备指纹检测                      │  │
│  │  禁用                      │  启用                              │  │
│  └────────────────────────────┴────────────────────────────────────┘  │
│                                                                         │
│  变更摘要:                                                              │
│  • 缩短Access Token过期时间: 30分钟 → 15分钟                           │
│  • 启用Token IP绑定                                                     │
│  • 轮换JWT签名密钥                                                      │
│                                                                         │
│  [ 回滚至 v10 ]                                           [ 关闭 ]     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3. 审计日志增强（异常高亮）

#### 3.1 功能点清单

##### 3.1.1 日志列表增强
**功能**:
- ✅ **实时刷新**: WebSocket实时推送新日志
- ✅ **异常高亮**: 
  - 🔴 高危操作（批量禁用、删除管理员、JWT密钥轮换）
  - 🟡 中危操作（配置修改、用户角色变更）
  - 🔵 普通操作（查询、导出）
- ✅ **智能筛选**: 
  - 操作类型（用户管理、配置管理、设备管理）
  - 操作人（下拉选择）
  - 时间范围（快捷选项：今天、本周、本月）
  - 状态（成功、失败）
  - IP地址（支持模糊搜索）
- ✅ **高级搜索**: 
  - 全文搜索（操作说明、错误信息）
  - Request ID追踪（跨服务链路查询）

##### 3.1.2 日志详情面板
**功能**:
- ✅ **结构化展示**: JSON数据格式化显示
- ✅ **变更对比**: Before/After数据Diff视图
- ✅ **链路追踪**: 点击Request ID跳转到Jaeger追踪
- ✅ **关联日志**: 显示同一Request ID的所有日志
- ✅ **敏感数据脱敏**: 手机号、Token自动打码

##### 3.1.3 异常活动告警
**功能**:
- ✅ **实时告警**: 检测到异常行为立即显示红色通知
- ✅ **告警类型**:
  - 批量操作（1小时内禁用20个用户）
  - 非工作时间操作（22:00-06:00修改配置）
  - 连续失败（5次登录失败）
  - 敏感操作（删除管理员、轮换密钥）
- ✅ **告警处理**: 
  - 查看详情
  - 确认（标记为已处理）
  - 静默（忽略此类告警24小时）
  - 联系管理员（发送邮件/Slack通知）

##### 3.1.4 日志导出
**功能**:
- ✅ **格式支持**: CSV、Excel、JSON
- ✅ **自定义字段**: 选择导出的列
- ✅ **大数据量**: 支持导出10万条+（异步任务）
- ✅ **加密导出**: 敏感日志导出自动加密（AES）

---

#### 3.2 页面草图

```
┌──────────────────────────────────────────────────────────────────────────┐
│ Listen Stream Admin - 审计日志                        [admin@system] ▼   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ 📍 导航: 首页 > 系统管理 > 审计日志                                ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐
│  │ 🚨 异常告警 (3)                                     [查看全部 >]     │
│  ├──────────────────────────────────────────────────────────────────────┤
│  │ 🔴 批量禁用用户  admin在10分钟内禁用了25个用户    刚刚  [查看]     │
│  │ 🟡 非工作时间操作 admin在凌晨02:30修改了JWT配置   2小时前 [查看]   │
│  │ 🟡 连续登录失败  IP 192.168.1.100 登录失败6次     3小时前 [查看]   │
│  └──────────────────────────────────────────────────────────────────────┘
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐
│  │ 筛选条件                                                              │
│  │ 操作类型: [全部 ▼]  操作人: [全部 ▼]  时间: [今天 ▼]  状态: [全部▼] │
│  │ 搜索: [Request ID / 操作说明 / IP地址]  🔍  [ 高级搜索 ]  [ 重置 ] │
│  └──────────────────────────────────────────────────────────────────────┘
│                                                                           │
│  [ 导出日志 ]  [ 🔄 自动刷新 ]  [ ⚙️ 列设置 ]                          │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐
│  │ 时间              操作人  操作类型      目标        状态   详情      │
│  ├──────────────────────────────────────────────────────────────────────┤
│  │ 🔴 14:32:15  admin   批量禁用用户   25个用户    成功   [👁 查看]   │
│  │ 🟡 14:30:00  admin   修改配置       JWT配置     成功   [👁 查看]   │
│  │ 🔵 14:25:10  admin   查询用户列表   -           成功   [👁 查看]   │
│  │ 🟡 14:20:05  admin   变更角色       user_123    成功   [👁 查看]   │
│  │ 🔵 14:15:30  viewer  导出日志       操作日志    成功   [👁 查看]   │
│  │ 🔴 14:10:15  admin   删除设备       device_456  失败   [👁 查看]   │
│  │ 🔵 14:05:00  admin   查询统计数据   -           成功   [👁 查看]   │
│  │ 🟡 13:55:40  admin   禁用用户       user_789    成功   [👁 查看]   │
│  │ ... (更多)                                                           │
│  └──────────────────────────────────────────────────────────────────────┘
│                                                                           │
│  第 1 页 / 共 42 页    [ ◀ ]  1  2  3 ... 42  [ ▶ ]    每页: [20 ▼]   │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

#### 3.3 日志详情侧边栏

```
┌────────────────────────────────────────────────────────────────────────┐
│                                                             [✕ 关闭]    │
│  操作详情                                                               │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 基本信息                                                          │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │  操作时间:  2026-03-01 14:32:15                                  │ │
│  │  操作人:    admin (super_admin)                                  │ │
│  │  操作类型:  批量禁用用户 🔴 高危                                  │ │
│  │  状态:      成功 ✅                                               │ │
│  │  IP地址:    192.168.1.50                                         │ │
│  │  User Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X...)         │ │
│  │  Request ID: req_abc123def456 [🔗 查看链路]                      │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 操作说明                                                          │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │  批量清理违规用户账号（收到投诉的刷榜账号）                      │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 变更数据 (25条记录)                                              │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │  Tab: [ JSON视图 ]  [ Diff视图 ]  [ 表格视图 ]                  │ │
│  │       ─────────                                                  │ │
│  │                                                                   │ │
│  │  [ Before ]                        [ After ]                     │ │
│  │  ┌──────────────────────┐         ┌──────────────────────┐     │ │
│  │  │ {                     │         │ {                     │     │ │
│  │  │   "users": [          │         │   "users": [          │     │ │
│  │  │     {                 │         │     {                 │     │ │
│  │  │       "id": "u_001",  │         │       "id": "u_001",  │     │ │
│  │  │ -     "disabled": false│       │ +     "disabled": true │     │ │
│  │  │     },                │         │     },                │     │ │
│  │  │     ...               │         │     ...               │     │ │
│  │  │   ]                   │         │   ]                   │     │ │
│  │  │ }                     │         │ }                     │     │ │
│  │  └──────────────────────┘         └──────────────────────┘     │ │
│  │                                                                   │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 关联日志 (3条)                                      [查看全部 >] │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │  14:32:15  auth-svc     验证Token      成功                      │ │
│  │  14:32:16  user-svc     批量更新用户   成功                      │ │
│  │  14:32:17  sync-svc     推送通知       成功                      │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  [ 标记为已审查 ]  [ 导出此日志 ]                        [ 关闭 ]     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

#### 3.4 异常告警详情

```
┌────────────────────────────────────────────────────────────────────────┐
│ 🚨 异常告警详情                                         [✕ 关闭]       │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  告警类型:  批量操作异常 🔴 高危                                        │
│  告警时间:  2026-03-01 14:35:00                                         │
│  严重级别:  Critical                                                    │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 告警详情                                                          │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │  管理员 "admin" 在 10 分钟内禁用了 25 个用户账号                 │ │
│  │                                                                   │ │
│  │  时间范围: 14:30:00 - 14:32:15                                   │ │
│  │  操作IP:   192.168.1.50                                          │ │
│  │  影响用户: u_001, u_002, u_003, ... (查看完整列表)               │ │
│  │                                                                   │ │
│  │  ⚠️  此操作已触发自动告警规则:                                    │ │
│  │  • 单次批量操作超过20个用户                                       │ │
│  │  • 操作时间间隔小于15分钟                                         │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 相关操作日志                                                      │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │  14:32:15  禁用用户  user_001  成功  [查看]                      │ │
│  │  14:32:10  禁用用户  user_002  成功  [查看]                      │ │
│  │  14:32:05  禁用用户  user_003  成功  [查看]                      │ │
│  │  ... (显示全部25条)                                              │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 建议措施                                                          │ │
│  ├──────────────────────────────────────────────────────────────────┤ │
│  │  1. 确认此操作是否为正常业务流程                                 │ │
│  │  2. 联系操作人 admin 核实操作原因                                │ │
│  │  3. 检查被禁用用户的账号情况                                     │ │
│  │  4. 如为误操作，可批量恢复用户账号                               │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  处理状态: [ 待处理 ]  [ 已确认 ]  [ 误报 ]                           │
│                                                                         │
│  处理备注:                                                              │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │ 已确认为正常操作，批量清理违规刷榜账号                          │   │
│  │                                                                  │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  [ 🔕 静默此类告警(24h) ]  [ 📧 通知超级管理员 ]  [ 确认并关闭 ]     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 4. 数据统计图表

#### 4.1 功能点清单

##### 4.1.1 概览仪表盘
**功能**:
- ✅ **关键指标卡片**:
  - 总用户数（今日新增）
  - 活跃用户数（7日活跃率）
  - 今日API调用量（环比增长）
  - 系统错误率（实时）
- ✅ **实时刷新**: 每30秒自动更新
- ✅ **时间范围**: 今天、本周、本月、自定义

##### 4.1.2 用户增长图表
**功能**:
- ✅ **折线图**: 显示用户增长趋势（30天）
- ✅ **柱状图**: 每日新增用户对比
- ✅ **预测曲线**: 基于历史数据预测未来7天增长（可选）
- ✅ **数据下钻**: 点击日期查看当天详情

##### 4.1.3 活跃度分析
**功能**:
- ✅ **活跃度分布**: 饼图显示活跃/非活跃用户占比
- ✅ **留存率**: 次日留存、7日留存、30日留存
- ✅ **热力图**: 每小时活跃用户分布

##### 4.1.4 内容统计
**功能**:
- ✅ **收藏/歌单/历史**: 三个指标折线图对比
- ✅ **TOP榜单**: 
  - TOP 10 最受欢迎歌曲（收藏数）
  - TOP 10 最活跃用户（播放量）
  - TOP 10 最热歌单（订阅数）

##### 4.1.5 系统性能
**功能**:
- ✅ **API调用量**: 折线图显示每小时调用量
- ✅ **错误率**: 红色区域标记错误率飙升时段
- ✅ **响应时间**: P50/P95/P99延迟趋势
- ✅ **缓存命中率**: L1/L2/L3缓存命中率对比

##### 4.1.6 短信统计
**功能**:
- ✅ **发送量**: 每日短信发送量柱状图
- ✅ **成功率**: 计算各厂商SMS成功率（阿里云、腾讯云、Twilio）
- ✅ **成本分析**: 每日短信费用趋势

---

#### 4.2 页面草图

```
┌──────────────────────────────────────────────────────────────────────────┐
│ Listen Stream Admin - 数据统计                        [admin@system] ▼   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ 📍 导航: 首页 > 数据分析 > 概览仪表盘                              ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                           │
│  时间范围: [ 今天 ]  [ 本周 ]  [ 本月 ]  [ 自定义 ]   🔄 最后更新: 30秒前│
│                                                                           │
│  ┌─────────┬─────────┬─────────┬─────────┬─────────────────────────────┐│
│  │ 📊 总用户│ 👥 活跃 │ 📱 API  │ ⚠️ 错误率│                             ││
│  │         │         │   调用   │         │                             ││
│  │ 12,345  │  8,234  │ 1.2M    │  0.05%  │                             ││
│  │ ↑ +123  │ 66.7%   │ ↑ +5%   │ ↓ -0.01%│                             ││
│  └─────────┴─────────┴─────────┴─────────┴─────────────────────────────┘│
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ 用户增长趋势 (最近30天)                         [导出] [放大]     │ │
│  ├────────────────────────────────────────────────────────────────────┤ │
│  │                                                                     │ │
│  │  12500 ┤                                                        ● │ │
│  │  12000 ┤                                                    ●   │ │ │
│  │  11500 ┤                                                ●       │ │ │
│  │  11000 ┤                                            ●           │ │ │
│  │  10500 ┤                                        ●               │ │ │
│  │  10000 ┤                                    ●                   │ │ │
│  │   9500 ┤                                ●                       │ │ │
│  │   9000 ┤                            ●                           │ │ │
│  │   8500 ┤                        ●                               │ │ │
│  │   8000 ┤────────────────────●───────────────────────────────────│ │ │
│  │         2/1  2/5  2/10  2/15  2/20  2/25  3/1                   │ │ │
│  │                                                                     │ │
│  │  图例: ───  总用户  ─ ─  新增用户  ····  预测趋势               │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌──────────────────────────────────────┬────────────────────────────┐  │
│  │ 每日新增用户 (最近7天)               │ 用户活跃度分布             │  │
│  ├──────────────────────────────────────┼────────────────────────────┤  │
│  │                                       │                            │  │
│  │  200 ┤     █                          │      活跃用户              │  │
│  │  150 ┤     █  █                       │      66.7%                 │  │
│  │  100 ┤ █   █  █  █                    │    ╱────╲                 │  │
│  │   50 ┤ █   █  █  █  █                 │   │ 📗  📕 │              │  │
│  │    0 ┼─█───█──█──█──█──█──█           │    ╲────╱                 │  │
│  │       25 26 27 28 29  1  2            │                            │  │
│  │                                       │  非活跃: 33.3%             │  │
│  └──────────────────────────────────────┴────────────────────────────┘  │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 内容统计 (最近30天)                                [导出] [放大] │   │
│  ├──────────────────────────────────────────────────────────────────┤   │
│  │                                                                   │   │
│  │  3000 ┤                                                      ●   │   │
│  │  2500 ┤                                                  ●   △   │   │
│  │  2000 ┤                                              ●   □       │   │
│  │  1500 ┤                                          ●               │   │
│  │  1000 ┤                                      ●                   │   │
│  │   500 ┤                                  ●                       │   │
│  │     0 ┼──────────────────────────────●───────────────────────────│   │
│  │        2/1    2/8    2/15   2/22   3/1                          │   │
│  │                                                                   │   │
│  │  图例: ●── 收藏  △── 歌单  □── 播放历史                        │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌──────────────────────────────────────┬────────────────────────────┐  │
│  │ TOP 10 热门歌曲                      │ 系统错误率 (今天)          │  │
│  ├──────────────────────────────────────┼────────────────────────────┤  │
│  │  1. 稻香 - 周杰伦            1,234   │  0.1% ┤                    │  │
│  │  2. 青花瓷 - 周杰伦          1,123   │       ┤                    │  │
│  │  3. 夜曲 - 周杰伦            1,089   │  0.05%┤          ⚠️        │  │
│  │  4. 七里香 - 周杰伦          1,056   │       ┤        ╱  ╲       │  │
│  │  5. 晴天 - 周杰伦              998   │       ┤       ╱    ╲      │  │
│  │  6. 彩虹 - 周杰伦              967   │  0%   ┼──────────────────  │  │
│  │  7. 告白气球 - 周杰伦          945   │        00 06 12 18 24      │  │
│  │  8. 龙卷风 - 周杰伦            923   │                            │  │
│  │  9. 简单爱 - 周杰伦            901   │  峰值: 10:30 (0.12%)       │  │
│  │ 10. 不能说的秘密 - 周杰伦      887   │  原因: 第三方API超时       │  │
│  └──────────────────────────────────────┴────────────────────────────┘  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

#### 4.3 系统性能详情页

```
┌──────────────────────────────────────────────────────────────────────────┐
│ Listen Stream Admin - 系统性能监控                    [admin@system] ▼   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  时间范围: [ 最近1小时 ▼ ]   🔄 自动刷新: [ 开启 ](30秒)               │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ API调用量 (QPS)                                       [导出] [放大]│ │
│  ├────────────────────────────────────────────────────────────────────┤ │
│  │                                                                     │ │
│  │  5000 ┤                                     ╱█╲                     │ │
│  │  4000 ┤                                   ╱█ █╲                     │ │
│  │  3000 ┤                             ╱█╲  ╱█   █╲                   │ │
│  │  2000 ┤                         ╱█ █ █╲█           █╲              │ │
│  │  1000 ┤                     ╱█  █                    █╲            │ │
│  │     0 ┼─────────────────█──────────────────────────────█───────────│ │
│  │        13:00   13:15   13:30   13:45   14:00   14:15   14:30      │ │
│  │                                                                     │ │
│  │  当前QPS: 3,245  峰值: 4,567 (14:15)  平均: 2,134                 │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ 响应时间分布 (毫秒)                                   [导出] [放大]│ │
│  ├────────────────────────────────────────────────────────────────────┤ │
│  │                                                                     │ │
│  │  200 ┤                                                           ● │ │
│  │  150 ┤                                                       ●   ■ │ │
│  │  100 ┤                                                   ●       ▲ │ │
│  │   50 ┤───────────────────────────────────────●──────────────────── │ │
│  │    0 ┼─────────────────────────────────●─────────────────────────  │ │
│  │        13:00   13:15   13:30   13:45   14:00   14:15   14:30      │ │
│  │                                                                     │ │
│  │  图例: ●── P50  ■── P95  ▲── P99                                  │ │
│  │  当前: P50=15ms  P95=45ms  P99=120ms                              │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌──────────────────────────────────────┬────────────────────────────┐  │
│  │ 缓存命中率                           │ 第三方API状态              │  │
│  ├──────────────────────────────────────┼────────────────────────────┤  │
│  │                                       │                            │  │
│  │  L1 (内存)    [████████] 89.5%       │  QQ Music   [✅ 正常]      │  │
│  │  L2 (Redis)   [██████  ] 75.3%       │  Joox       [✅ 正常]      │  │
│  │  L3 (Stale)   [█      ] 12.1%        │  NetEase    [⚠️ 降级]      │  │
│  │                                       │  Kugou      [✅ 正常]      │  │
│  │  总命中率: 82.7%                      │                            │  │
│  │  未命中: 17.3%                        │  熔断器状态:               │  │
│  │                                       │  • QQ: Open (0/5)          │  │
│  │  近7天趋势:                           │  • Joox: Open (0/5)        │  │
│  │  ↑ +2.3%                              │  • NetEase: Closed (5/5)   │  │
│  │                                       │  • Kugou: Open (1/5)       │  │
│  └──────────────────────────────────────┴────────────────────────────┘  │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ 服务健康状态                                                        │ │
│  ├────────────────────────────────────────────────────────────────────┤ │
│  │  服务名       实例    状态    QPS    P99延迟   内存    CPU         │ │
│  ├────────────────────────────────────────────────────────────────────┤ │
│  │  auth-svc     3       ✅     1.2k    8ms      512MB   25%          │ │
│  │  proxy-svc    5       ✅     4.5k    15ms     1GB     45%          │ │
│  │  user-svc     2       ✅     800     12ms     256MB   15%          │ │
│  │  sync-svc     2       ⚠️    200     50ms     512MB   30%          │ │
│  │  admin-svc    1       ✅     50      5ms      128MB   5%           │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 📝 技术实现要点

### 1. 前端技术栈

```typescript
// 主要依赖
{
  "dependencies": {
    "react": "^19.0.0",
    "typescript": "^5.7.3",
    "@radix-ui/react-*": "latest",  // UI组件
    "recharts": "^2.15.0",          // 图表
    "@tanstack/react-query": "^5.65.1",  // 数据获取
    "zustand": "^5.0.3",            // 状态管理
    "axios": "^1.7.9",              // HTTP
    "react-router-dom": "^7.1.3",   // 路由
    "react-hook-form": "^7.54.2",   // 表单
    "zod": "^3.23.8",               // 验证
    "date-fns": "^4.1.0",           // 日期处理
    "tailwindcss": "^4.0.6",        // 样式
    "react-diff-viewer": "^3.1.1",  // Diff对比
    "react-json-view": "^1.21.3",   // JSON查看器
    "file-saver": "^2.0.5"          // 文件导出
  }
}
```

### 2. 状态管理

```typescript
// stores/config-store.ts
import { create } from 'zustand';

interface ConfigStore {
  versions: ConfigVersion[];
  currentVersion: ConfigVersion | null;
  isLoading: boolean;
  fetchVersions: () => Promise<void>;
  rollback: (versionId: string) => Promise<void>;
}

export const useConfigStore = create<ConfigStore>((set) => ({
  versions: [],
  currentVersion: null,
  isLoading: false,
  fetchVersions: async () => {
    set({ isLoading: true });
    const data = await api.getConfigVersions();
    set({ versions: data, isLoading: false });
  },
  rollback: async (versionId) => {
    await api.rollbackConfig(versionId);
    // 重新加载
  },
}));
```

### 3. 实时数据更新

```typescript
// hooks/use-realtime-stats.ts
import { useQuery } from '@tanstack/react-query';
import { useWebSocket } from './use-websocket';

export function useRealtimeStats() {
  // 定时轮询
  const { data: stats } = useQuery({
    queryKey: ['stats', 'realtime'],
    queryFn: api.getRealtimeStats,
    refetchInterval: 30000, // 30秒
  });

  // WebSocket实时推送
  const { lastMessage } = useWebSocket('/ws/stats');

  return {
    stats: lastMessage || stats,
  };
}
```

### 4. 图表组件封装

```typescript
// components/charts/line-chart.tsx
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

interface Props {
  data: { date: string; value: number }[];
  color?: string;
}

export function CustomLineChart({ data, color = '#3b82f6' }: Props) {
  return (
    <ResponsiveContainer width="100%" height={300}>
      <LineChart data={data}>
        <XAxis dataKey="date" />
        <YAxis />
        <Tooltip />
        <Line type="monotone" dataKey="value" stroke={color} strokeWidth={2} />
      </LineChart>
    </ResponsiveContainer>
  );
}
```

---

## ✅ 验收标准

### 功能验收

- [ ] **配置管理**:
  - [ ] 所有配置可编辑并实时生效
  - [ ] 版本历史可查看、对比、回滚
  - [ ] 敏感字段加密存储
  - [ ] 变更通知实时推送

- [ ] **审计日志**:
  - [ ] 日志实时刷新（WebSocket）
  - [ ] 异常高亮显示
  - [ ] 筛选、搜索功能正常
  - [ ] 日志导出（CSV/Excel）
  - [ ] 告警自动检测并通知

- [ ] **数据统计**:
  - [ ] 所有图表数据准确
  - [ ] 实时刷新（30秒）
  - [ ] 响应速度 < 1秒
  - [ ] 图表可导出（PNG/PDF）

### 性能验收

- [ ] 首屏加载时间 < 2秒
- [ ] 图表渲染时间 < 500ms
- [ ] 日志列表滚动流畅（虚拟列表）
- [ ] 大数据量导出不阻塞UI（Web Worker）

### 兼容性验收

- [ ] Chrome 100+
- [ ] Firefox 100+
- [ ] Safari 15+
- [ ] Edge 100+

---

## 🚀 部署说明

### 构建

```bash
cd admin
npm install
npm run build
```

### 环境变量

```bash
# .env.production
VITE_API_BASE_URL=https://api.listen-stream.com
VITE_WS_URL=wss://api.listen-stream.com/ws
VITE_SENTRY_DSN=your-sentry-dsn
```

### Nginx配置

```nginx
server {
  listen 443 ssl http2;
  server_name admin.listen-stream.com;

  root /var/www/admin/dist;
  index index.html;

  location / {
    try_files $uri $uri/ /index.html;
  }

  location /api {
    proxy_pass http://admin-svc:8005;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /ws {
    proxy_pass http://sync-svc:8004;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}
```

---

## 📚 参考资料

- [Radix UI Documentation](https://www.radix-ui.com/)
- [Recharts Documentation](https://recharts.org/)
- [TanStack Query Documentation](https://tanstack.com/query)
- [React Hook Form Documentation](https://react-hook-form.com/)
